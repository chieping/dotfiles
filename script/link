#!/bin/bash
set -e

DOTFILES_DIR=${DOTFILES_DIR:-~/.dotfiles}

vim() {
  mkdir -p ~/.vim/{backups,swaps,undo,bundle}
  ln -sf $DOTFILES_DIR/gvimrc ~/.gvimrc
  ln -sf $DOTFILES_DIR/vimrc ~/.vimrc
  ln -sfn ~/.vim ~/.config/nvim
  ln -sf $DOTFILES_DIR/vimrc ~/.config/nvim/init.vim
  ln -sf $DOTFILES_DIR/vim/filetype.vim ~/.vim/filetype.vim
  ln -sfn $DOTFILES_DIR/vim/nerdtree_plugin ~/.vim/nerdtree_plugin
  ln -sfn $DOTFILES_DIR/vim/UltiSnips ~/.vim/UltiSnips
}

tmux() {
  ln -sf $DOTFILES_DIR/tmux.conf ~/.tmux.conf
}

continue_on_error() {
  set +e
  $@
  if ! [ $? = 0 ]; then
    echo "a command failed: $@"
    echo "continue anyway..."
  fi
  set -e
}

rest() {
  ln -sf $DOTFILES_DIR/bashrc ~/.bashrc
  ln -sf $DOTFILES_DIR/ctags ~/.ctags
  ln -sf $DOTFILES_DIR/eslintrc ~/.eslintrc
  ln -sf $DOTFILES_DIR/gitconfig ~/.gitconfig
  ln -sf $DOTFILES_DIR/gitignore ~/.gitignore
  ln -sf $DOTFILES_DIR/irbrc ~/.irbrc
  ln -sf $DOTFILES_DIR/pryrc ~/.pryrc
  ln -sf $DOTFILES_DIR/rubocop.yml ~/.rubocop.yml
  ln -sf $DOTFILES_DIR/tigrc ~/.tigrc
  ln -sf $DOTFILES_DIR/vimperatorrc ~/.vimperatorrc
  ln -sf $DOTFILES_DIR/zshrc ~/.zshrc
  ln -sf $DOTFILES_DIR/zshrc.darwin ~/.zshrc.darwin
  ln -sf $DOTFILES_DIR/zshrc.linux ~/.zshrc.linux
  ln -sf $DOTFILES_DIR/gemrc ~/.gemrc
  ln -sf $DOTFILES_DIR/agignore ~/.agignore

  mkdir -p ~/.atom
  ln -sf $DOTFILES_DIR/atom/config.cson ~/.atom/config.cson
  ln -sf $DOTFILES_DIR/atom/init.coffee ~/.atom/init.coffee
  ln -sf $DOTFILES_DIR/atom/keymap.cson ~/.atom/keymap.cson
  ln -sf $DOTFILES_DIR/atom/snippets.cson ~/.atom/snippets.cson
  ln -sf $DOTFILES_DIR/atom/styles.less ~/.atom/styles.less

  mkdir -p ~/.lein
  ln -sf $DOTFILES_DIR/profiles.clj ~/.lein/profiles.clj

  mkdir -p ~/.rbenv
  ln -sf $DOTFILES_DIR/rbenv/default-gems ~/.rbenv/default-gems

  mkdir -p ~/.git_templates/hooks
  ls $DOTFILES_DIR/git_templates/hooks | xargs -I% ln -sf $DOTFILES_DIR/git_templates/hooks/% ~/.git_templates/hooks/%

  mkdir -p ~/.vimperator/plugin
  ln -sf ~/src/github.com/vimpr/vimperator-plugins/plugin_loader.js ~/.vimperator/plugin/plugin_loader.js

  ln -sfn $DOTFILES_DIR/peco ~/.peco

  mkdir -p ~/.oh-my-zsh/custom/themes
  ln -sf $DOTFILES_DIR/oh-my-zsh/custom/themes/gallois.zsh-theme ~/.oh-my-zsh/custom/themes/gallois.zsh-theme

  # TODO: this is not working as intended
  continue_on_error ln -s $DOTFILES_DIR/ssh ~/.ssh

  mkdir -p ~/bin

  touch ~/.zshrc.local
}

is_valid_param() {
  [[ $1 =~ ^(all|vim_only|tmux_only)$ ]]
}

main() {
  if [ $# = 0 ] || ! is_valid_param $1; then
    echo "Usage: ./link [all|vim_only|tmux_only]"
    exit
  fi

  echo "DOTFILES_DIR: $DOTFILES_DIR"
  echo "you will setup [$1]"
  echo -n "proceed?(y/n): "
  read answer
  if [[ ! $answer =~ ^y ]]; then
    echo quit
    exit
  fi

  if [ $1 = all ]; then
    vim
    tmux
    rest
  elif [ $1 = vim_only ]; then
    vim
  elif [ $1 = tmux_only ]; then
    tmux
  fi
}

main $*
